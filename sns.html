<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Goggle SNS</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
    #sidebar {
      width: 200px;
      background: #f0f0f0;
      padding: 20px;
      box-sizing: border-box;
    }
    #main {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    h2 { margin-top: 0; }
    .course-item { padding: 10px; border: 1px solid #ccc; margin: 5px 0; cursor: pointer; border-radius: 4px; }
    .course-item:hover { background: #eef; }
    #version-detail, #admin-password-box { display: none; }
    #message-list { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .message-item { border-bottom: 1px dashed #aaa; padding: 5px 0; }
    #create-course-form, #message-form { margin: 10px 0; }
    input, textarea { width: 100%; box-sizing: border-box; margin: 5px 0; padding: 8px; }
    button { padding: 8px 16px; margin-top: 5px; cursor: pointer; }
    #course-password-modal {
      display: none;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center; align-items: center;
    }
    #course-password-box {
      background: white; padding: 20px; border-radius: 6px; width: 300px;
    }
  </style>
</head>
<body>
  <!-- ä¾§è¾¹æ  -->
  <div id="sidebar">
    <h3 id="gc-icon" style="cursor: pointer;">ğŸ§± Goggle Classroom</h3>
    <div id="version-detail">
      ãƒãƒ¼ã‚¸ãƒ§ãƒ³: <span id="vnum" style="color: gray; cursor: pointer;">12.3.7</span>
    </div>
    <div id="admin-password-box">
      <input type="password" id="admin-pass" placeholder="ç®¡ç†å‘˜å¯†ç ">
      <button onclick="enterAdmin()">è¿›å…¥åå°</button>
    </div>
    <hr>
    <button onclick="openTeacherLink()">ğŸ“ å…ˆç”Ÿã‚­ãƒ¼</button>
  </div>

  <!-- ä¸»åŒº -->
  <div id="main">
    <h2>æ¬¢è¿ï¼Œ<span id="user-display"></span>ï¼</h2>
    <h3>æ‰€æœ‰è¯¾ç¨‹ï¼š</h3>
    <div id="course-list"></div>

    <h3>åˆ›å»ºæ–°è¯¾ç¨‹ï¼š</h3>
    <div id="create-course-form">
      <input type="text" id="new-course-name" placeholder="è¯¾ç¨‹åç§°">
      <input type="text" id="new-course-password" placeholder="è¯¾ç¨‹å¯†ç ï¼ˆé€‰å¡«ï¼‰">
      <button onclick="createCourse()">åˆ›å»ºè¯¾ç¨‹</button>
      <p id="create-course-error" style="color:red;"></p>
    </div>

    <!-- ç•™è¨€åŒºï¼šåˆå§‹éšè—ï¼Œç‚¹å‡»è¯¾ç¨‹åæ‰æ˜¾ç¤º -->
    <div id="message-section" style="display:none;">
      <h3>è¯¾ç¨‹ï¼š<span id="current-course-name"></span></h3>
      <div id="message-list"></div>
      <div id="message-form">
        <textarea id="new-message-content" rows="3" placeholder="è¾“å…¥ç•™è¨€å†…å®¹"></textarea>
        <button onclick="postMessage()">å‘é€ç•™è¨€</button>
        <p id="post-message-error" style="color:red;"></p>
      </div>
    </div>
  </div>

  <!-- è¯¾ç¨‹å¯†ç è¾“å…¥å¼¹çª— -->
  <div id="course-password-modal">
    <div id="course-password-box">
      <p>æ­¤è¯¾ç¨‹éœ€è¦å¯†ç ï¼Œè¯·è¾“å…¥ï¼š</p>
      <input type="password" id="course-password-input" placeholder="è¯¾ç¨‹å¯†ç ">
      <button onclick="verifyCoursePassword()">ç¡®è®¤</button>
      <button onclick="closeCourseModal()">å–æ¶ˆ</button>
      <p id="course-password-error" style="color:red;"></p>
    </div>
  </div>

  <script>
    // ========== å…¨å±€å˜é‡ ==========
    const WEB_APP_URL = 'YOUR_WEB_APP_URL'; // æ›¿æ¢æˆçœŸå®çš„ Apps Script Web App URL
    let currentCourse = null;      // å½“å‰é€‰ä¸­çš„è¯¾ç¨‹å¯¹è±¡ { courseId, courseName, owner, hasPassword }
    let allCourses = [];           // ç¼“å­˜æ‹‰å–åˆ°çš„è¯¾ç¨‹åˆ—è¡¨
    const username = localStorage.getItem('username');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    window.onload = function() {
      if (!username) {
        // å¦‚æœæ²¡ç™»å½•ï¼Œç›´æ¥å›åˆ° login.html
        window.location.href = 'login.html';
        return;
      }
      document.getElementById('user-display').innerText = username;
      loadCourses();
    };

    // ========== è¯¾ç¨‹åˆ—è¡¨ & åˆ›å»º ==========
    function loadCourses() {
      fetch(`${WEB_APP_URL}?path=getCourses`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            allCourses = data.courses;
            renderCourseList();
          } else {
            alert('æ‹‰å–è¯¾ç¨‹å¤±è´¥ï¼š' + data.error);
          }
        })
        .catch(err => console.error(err));
    }

    function renderCourseList() {
      const container = document.getElementById('course-list');
      container.innerHTML = '';
      allCourses.forEach(course => {
        const div = document.createElement('div');
        div.className = 'course-item';
        div.innerText = `${course.courseName}   ï¼ˆåˆ›å»ºè€…ï¼š${course.owner}${course.hasPassword ? ' ğŸ”’' : ''}ï¼‰`;
        div.onclick = () => onSelectCourse(course);
        container.appendChild(div);
      });
    }

    function createCourse() {
      const name = document.getElementById('new-course-name').value.trim();
      const pwd = document.getElementById('new-course-password').value.trim();
      if (!name) {
        document.getElementById('create-course-error').innerText = 'è¯¾ç¨‹åç§°ä¸èƒ½ä¸ºç©º';
        return;
      }
      document.getElementById('create-course-error').innerText = '';
      const url = `${WEB_APP_URL}?path=createCourse&courseName=${encodeURIComponent(name)}&owner=${encodeURIComponent(username)}&password=${encodeURIComponent(pwd)}`;
      fetch(url).then(res => res.json()).then(data => {
        if (data.success) {
          // åˆ·æ–°è¯¾ç¨‹åˆ—è¡¨
          loadCourses();
          document.getElementById('new-course-name').value = '';
          document.getElementById('new-course-password').value = '';
        } else {
          document.getElementById('create-course-error').innerText = data.error;
        }
      }).catch(err => console.error(err));
    }

    // ========== é€‰ä¸­å¹¶æ‰“å¼€è¯¾ç¨‹ ==========
    function onSelectCourse(course) {
      currentCourse = course;
      if (course.hasPassword) {
        // å¼¹å‡ºè¾“å…¥å¯†ç å¼¹çª—
        document.getElementById('course-password-modal').style.display = 'flex';
        document.getElementById('course-password-input').value = '';
        document.getElementById('course-password-error').innerText = '';
      } else {
        openCourseAfterVerify();
      }
    }

    function verifyCoursePassword() {
      const inputPwd = document.getElementById('course-password-input').value.trim();
      if (inputPwd === currentCourse.password) {
        closeCourseModal();
        openCourseAfterVerify();
      } else {
        document.getElementById('course-password-error').innerText = 'å¯†ç é”™è¯¯';
      }
    }

    function closeCourseModal() {
      document.getElementById('course-password-modal').style.display = 'none';
    }

    function openCourseAfterVerify() {
      document.getElementById('current-course-name').innerText = currentCourse.courseName;
      document.getElementById('message-section').style.display = 'block';
      loadMessages();
    }

    // ========== ç•™è¨€åŠŸèƒ½ ==========
    function loadMessages() {
      const url = `${WEB_APP_URL}?path=getMessages&courseId=${encodeURIComponent(currentCourse.courseId)}`;
      fetch(url).then(res => res.json()).then(data => {
        if (data.success) {
          renderMessages(data.messages);
        } else {
          alert('æ‹‰å–ç•™è¨€å¤±è´¥ï¼š' + data.error);
        }
      }).catch(err => console.error(err));
    }

    function renderMessages(messages) {
      const container = document.getElementById('message-list');
      container.innerHTML = '';
      messages.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message-item';
        div.innerHTML = `<strong>${msg.author}</strong> <em>${msg.timestamp}</em><br>${msg.content}`;
        container.appendChild(div);
      });
      // æ»šåŠ¨åˆ°åº•éƒ¨
      container.scrollTop = container.scrollHeight;
    }

    function postMessage() {
      const content = document.getElementById('new-message-content').value.trim();
      if (!content) {
        document.getElementById('post-message-error').innerText = 'ç•™è¨€å†…å®¹ä¸èƒ½ä¸ºç©º';
        return;
      }
      document.getElementById('post-message-error').innerText = '';
      const url = `${WEB_APP_URL}?path=postMessage&courseId=${encodeURIComponent(currentCourse.courseId)}&author=${encodeURIComponent(username)}&content=${encodeURIComponent(content)}`;
      fetch(url).then(res => res.json()).then(data => {
        if (data.success) {
          document.getElementById('new-message-content').value = '';
          loadMessages(); // é‡æ–°æ‹‰å–ç•™è¨€
        } else {
          document.getElementById('post-message-error').innerText = data.error;
        }
      }).catch(err => console.error(err));
    }

    // ========== è€å¸ˆé”® & ç®¡ç†å‘˜å…¥å£ ==========
    function openTeacherLink() {
      // è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰è·³è½¬é“¾æ¥ï¼Œæ¯”å¦‚çœŸæ­£çš„ Google Classroom
      window.open('https://classroom.google.com', '_blank');
    }

    // åŒå‡» Goggle Classroom å›¾æ ‡å‡ºç°ç‰ˆæœ¬è¯¦æƒ…
    let gcClickCount = 0;
    document.getElementById('gc-icon').addEventListener('click', () => {
      gcClickCount++;
      if (gcClickCount === 2) {
        document.getElementById('version-detail').style.display = 'block';
      }
    });

    // ç‚¹å‡»ç‰ˆæœ¬å·å‡ºç°ç®¡ç†å‘˜å¯†ç è¾“å…¥
    document.getElementById('vnum').addEventListener('click', () => {
      document.getElementById('admin-password-box').style.display = 'block';
    });

    function enterAdmin() {
      const pwd = document.getElementById('admin-pass').value.trim();
      if (!isAdmin) {
        alert('ä½ ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ— æ³•è¿›å…¥åå°');
        return;
      }
      // è°ƒç”¨ admin_getAllData åªæ˜¯ä¸ºäº†éªŒè¯ç®¡ç†å‘˜è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®
      const url = `${WEB_APP_URL}?path=admin_getAllData&username=${encodeURIComponent(username)}&password=${encodeURIComponent(pwd)}`;
      fetch(url).then(res => res.json()).then(data => {
        if (data.success) {
          // éªŒè¯é€šè¿‡ï¼Œè·³è½¬åˆ° admin.html
          window.location.href = 'admin.html';
        } else {
          alert('ç®¡ç†å‘˜éªŒè¯å¤±è´¥ï¼š' + data.error);
        }
      }).catch(err => console.error(err));
    }

  </script>
</body>
</html>
